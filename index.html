<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ACTFL 3D Proficiency Pyramid ‚Äì SDC Long Sequence Spanish</title>
<style>
  :root{
    --bg:#0b1020; --text:#e9eefc; --muted:#a9b6e6;
    --border:rgba(255,255,255,.12); --shadow:0 20px 60px rgba(0,0,0,.45); --radius:16px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% 0%, #16265a 0%, var(--bg) 45%, #070a14 100%);color:var(--text);font-family:var(--sans);}
  .app{display:grid;grid-template-columns:minmax(360px,1.1fr) minmax(360px,.9fr);gap:16px;min-height:100vh;padding:16px;box-sizing:border-box;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
  .topbar{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.18);flex-wrap:wrap;}
  select,button{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:14px;outline:none;}
  button{cursor:pointer;}
  button:hover{background:rgba(255,255,255,.10);}
  .hint{color:var(--muted);font-size:12px;margin-left:auto;}
  #stageWrap{height:min(62vh,620px);min-height:420px;position:relative;}
  #stage{width:100%;height:100%;display:block;}
  .right{display:flex;flex-direction:column;}
  .panel{padding:14px;}
  .h1{font-size:18px;font-weight:800;margin:2px 0 6px;}
  .sub{color:var(--muted);font-size:13px;margin:0 0 10px;}
  .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px;}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);}
  .pill b{font-family:var(--mono);}
  .box{background:rgba(0,0,0,.16);border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:10px;}
  .box h3{margin:0 0 8px;font-size:13px;color:var(--muted);letter-spacing:.02em;text-transform:uppercase;}
  .desc{line-height:1.45;font-size:14px;}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;margin-top:8px;}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top;}
  th{color:var(--muted);font-weight:600;text-align:left;}
  tr:last-child td{border-bottom:none;}
  .status{font-weight:800;}
  .muted{color:var(--muted);}
  .toast{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.14);color:var(--text);
    padding:8px 10px;border-radius:12px;font-size:12px;opacity:0;transform:translateY(6px);transition:.18s;pointer-events:none;}
  .toast.show{opacity:1;transform:translateY(0);}
  @media (max-width: 980px){
    .app{grid-template-columns:1fr;}
    #stageWrap{height:520px;}
    .hint{margin-left:0;width:100%;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="topbar">
      <select id="modeSelect"></select>
      <select id="skillSelect"></select>
      <button id="resetBtn">Reset view</button>
      <div class="hint">Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Click a slice</div>
    </div>
    <div id="stageWrap">
      <canvas id="stage"></canvas>
      <div class="toast" id="toast"></div>
    </div>
  </div>

  <div class="card right">
    <div class="panel">
      <div class="h1">ACTFL 3D Proficiency Pyramid</div>
      <div class="sub">Click a slice to see ACTFL ‚ÄúFull Spectrum‚Äù + SDC Long Sequence expectations.</div>

      <div class="pillrow">
        <div class="pill">Selected: <b id="selCode">‚Äî</b></div>
        <div class="pill">Band: <span id="selBand" class="muted">‚Äî</span></div>
        <div class="pill">Mode: <span id="selMode" class="muted">‚Äî</span></div>
        <div class="pill">Skill: <span id="selSkill" class="muted">‚Äî</span></div>
      </div>

      <div class="box">
        <h3>ACTFL descriptor</h3>
        <div class="desc" id="actflDesc">Select a slice to view the descriptor for this mode/skill.</div>
      </div>

      <div class="box">
        <h3>SDC Long Sequence expectation by course</h3>
        <div class="muted" style="font-size:12px;margin-bottom:8px;">
          Shows where each course/grade is marked üå± Entry / üåø Target / üå≥ Emerging at the selected slice.
        </div>
        <div id="courseTableWrap"></div>
      </div>

      <div class="box">
        <h3>Legend</h3>
        <div class="desc">üå± <span class="status">Entry</span> ‚Ä¢ üåø <span class="status">Target</span> ‚Ä¢ üå≥ <span class="status">Emerging</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= DATA (embedded) ========= */
const DATA = {"modes": {"Interpretive": {"Interpretive Listening ‚Äì Full Spectrum": {"descriptors": {"N1": "Recognizes isolated words and memorized phrases with strong contextual support.", "N2": "Understands main ideas and isolated details in short, familiar audio texts.", "N4": "Follows simple spoken messages beyond rehearsed material with partial comprehension.", "I1": "Understands sentence-length spoken language on everyday topics.", "I2": "Understands connected spoken discourse with predictable structure.", "I5": "Understands most conversations on familiar topics, including narration and description.", "A1": "Understands paragraph-length spoken discourse across time frames.", "A2": "Understands detailed spoken texts on personal and public topics.", "A3": "Understands extended discourse with nuance and detail across contexts."}, "grades": {"1st Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "2nd Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "3rd Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "4th Grade": {"N1": "üå± Entry", "N2": "üåø Target", "N3": "üå≥ Emerging"}, "5th Grade": {"N2": "üå± Entry", "N3": "üåø Target", "N4": "üå≥ Emerging"}, "6th Grade": {"N3": "üå± Entry", "N4": "üåø Target", "I1": "üå≥ Emerging"}, "7th Grade": {"N4": "üå± Entry", "I1": "üåø Target", "I2": "üå≥ Emerging"}, "8th Grade": {"N4": "üå± Entry", "I1": "üåø Target", "I2": "üå≥ Emerging"}, "Honors Spanish I": {"I2": "üå± Entry", "I3": "üåø Target", "I4": "üå≥ Emerging"}, "9th Grade Honors": {"I3": "üå± Entry", "I4": "üåø Target", "I5": "üå≥ Emerging"}, "Honors Spanish II": {"I4": "üå± Entry", "I5": "üåø Target", "A1": "üå≥ Emerging"}, "Interpretive Reading ‚Äì \nFull Spectrum": {"N1": "Identifies familiar words, symbols, and cognates in isolation.", "N2": "Understands short, simple texts on familiar topics using context and visuals.", "N4": "Grasps the gist of short paragraph-length texts when scaffolded.", "I1": "Understands sentence-level texts across everyday contexts.", "I2": "Understands connected texts with organization and supporting detail.", "I5": "Understands narrations and descriptions in familiar genres.", "A1": "Understands paragraph-length texts across time frames.", "A2": "Understands detailed, organized texts on personal and public topics.", "A3": "Understands extended texts with nuance and perspective."}}}}, "Interpersonal": {"Interpersonal Oral Interaction ‚Äì Full Spectrum": {"descriptors": {"N1": "Exchanges meaning using isolated words and memorized phrases, relying heavily on repetition, gestures, and support. Understanding and responses are limited and often fragmented.", "N2": "Participates in simple, predictable exchanges using short sentences. Understands and responds to direct questions related to self and immediate environment, though interaction is often reactive.", "N4": "Manages uncomplicated conversations by asking and answering simple questions. Begins to recombine language and repair breakdowns, but cannot yet sustain interaction consistently.", "I1": "Creates with language to handle everyday interactions and transactions. Can initiate, maintain, and close simple conversations across familiar contexts.", "I2": "Sustains interaction using strings of sentences. Can exchange information, clarify meaning, and maintain conversations on familiar topics with increased independence.", "I5": "Participates in conversations with emerging narration and description, but performance is not yet consistently paragraph-length.", "A1": "Sustains paragraph-length interaction, narrating and describing in past, present, and future time frames. Can handle situations with a complication.", "A2": "Engages confidently in extended conversations with detail, organization, and clarity, interweaving narration and description.", "A3": "Communicates with ease, precision, and fluency across contexts, adapting language to the interaction and interlocutor."}, "grades": {}}, "Interpersonal Written Interaction ‚Äì Full Spectrum": {"descriptors": {"N1": "Exchanges meaning by copying or reproducing familiar words and phrases. Relies heavily on models and may switch to another language to maintain interaction.", "N2": "Participates in simple written exchanges using short, practiced sentences. Can read and respond to highly predictable messages on familiar topics.", "N4": "Manages basic written interactions by asking and answering simple questions and recombining familiar language, though exchanges remain short and uneven.", "I1": "Creates with language in written exchanges to meet everyday needs. Can maintain back-and-forth communication using connected sentences.", "I2": "Sustains written interaction using strings of sentences, clarifying meaning and exchanging information across familiar contexts.", "I5": "Participates in written exchanges with emerging paragraph-level organization, though breakdowns may occur when complexity increases.", "A1": "Sustains paragraph-length written interaction, narrating and describing across time frames in exchanges.", "A2": "Engages in extended written interaction with detail, cohesion, and clarity, adjusting language to context and audience.", "A3": "Writes interactively with precision, nuance, and stylistic control, maintaining coherent and purposeful exchanges across contexts."}, "grades": {}}}, "Presentational": {"Presentational Speaking ‚Äì Full Spectrum": {"descriptors": {"N1": "Produces lists and memorized phrases.", "N2": "Presents basic information using short sentences on familiar topics.", "N4": "Produces connected sentences to express personal meaning.", "I1": "Creates with language to present on everyday topics.", "I2": "Sustains organized presentations using sentence strings.", "I5": "Presents with emerging paragraph-level organization.", "A1": "Produces paragraph-length presentations across time frames.", "A2": "Produces detailed, organized presentations on personal and public topics.", "A3": "Presents with clarity, precision, and rhetorical control."}, "grades": {"1st Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "2nd Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "3rd Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "4th Grade": {"N1": "üå± Entry", "N2": "üåø Target", "N3": "üå≥ Emerging"}, "5th Grade": {"N2": "üå± Entry", "N3": "üåø Target", "N4": "üå≥ Emerging"}, "6th Grade": {"N3": "üå± Entry", "N4": "üåø Target", "I1": "üå≥ Emerging"}, "7th Grade": {"N4": "üå± Entry", "I1": "üåø Target", "I2": "üå≥ Emerging"}, "8th Grade": {"N4": "üå± Entry", "I1": "üåø Target", "I2": "üå≥ Emerging"}, "Honors Spanish I": {"I2": "üå± Entry", "I3": "üåø Target", "I4": "üå≥ Emerging"}, "9th Grade Honors": {"I3": "üå± Entry", "I4": "üåø Target", "I5": "üå≥ Emerging"}, "Honors Spanish II": {"I4": "üå± Entry", "I5": "üåø Target", "A1": "üå≥ Emerging"}}}, "Presentational Writing ‚Äì Full Spectrum": {"descriptors": {"N1": "Copies or reproduces words and phrases.", "N2": "Writes simple sentences and short messages on familiar topics.", "N4": "Begins short paragraph-like writing through recombination.", "I1": "Writes connected sentences to communicate meaning.", "I2": "Writes organized texts using sentence strings.", "I5": "Writes with emerging paragraph structure and narration.", "A1": "Writes paragraph-length texts across time frames.", "A2": "Writes detailed, organized texts with cohesion and clarity.", "A3": "Writes with precision, nuance, and stylistic control."}, "grades": {"1st Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "2nd Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "3rd Grade": {"N1": "üåø Target", "N2": "üå≥ Emerging"}, "4th Grade": {"N1": "üå± Entry", "N2": "üåø Target", "N3": "üå≥ Emerging"}, "5th Grade": {"N2": "üå± Entry", "N3": "üåø Target", "N4": "üå≥ Emerging"}, "6th Grade": {"N3": "üå± Entry", "N4": "üåø Target", "I1": "üå≥ Emerging"}, "7th Grade": {"N4": "üå± Entry", "I1": "üåø Target", "I2": "üå≥ Emerging"}, "8th Grade": {"N4": "üå± Entry", "I1": "üåø Target", "I2": "üå≥ Emerging"}, "Honors Spanish I": {"I2": "üå± Entry", "I3": "üåø Target", "I4": "üå≥ Emerging"}, "9th Grade Honors": {"I3": "üå± Entry", "I4": "üåø Target", "I5": "üå≥ Emerging"}, "Honors Spanish II": {"I4": "üå± Entry", "I5": "üåø Target", "A1": "üå≥ Emerging"}}}}}};

/* ========= Basics ========= */
const SLICE_ORDER = ["N1","N2","N3","N4","I1","I2","I3","I4","I5","A1","A2","A3"];
const CODE_TO_LABEL = {
  N1:"Novice Low", N2:"Novice Mid", N3:"Novice Mid-High", N4:"Novice High",
  I1:"Intermediate Low", I2:"Intermediate Mid", I3:"Intermediate Mid-High", I4:"Intermediate High", I5:"Intermediate High+",
  A1:"Advanced Low", A2:"Advanced Mid", A3:"Advanced High"
};
function bandOf(code){
  if(code.startsWith("N")) return "Novice";
  if(code.startsWith("I")) return "Intermediate";
  if(code.startsWith("A")) return "Advanced";
  return "‚Äî";
}
const BAND_COLOR = {
  Novice: [61,123,214],
  Intermediate: [85,176,106],
  Advanced: [224,122,47]
};

/* ========= UI ========= */
const modeSelect = document.getElementById("modeSelect");
const skillSelect = document.getElementById("skillSelect");
const resetBtn = document.getElementById("resetBtn");
const selCode = document.getElementById("selCode");
const selBand = document.getElementById("selBand");
const selMode = document.getElementById("selMode");
const selSkill = document.getElementById("selSkill");
const actflDesc = document.getElementById("actflDesc");
const courseTableWrap = document.getElementById("courseTableWrap");
const toast = document.getElementById("toast");

const modeNames = Object.keys(DATA.modes);
modeNames.forEach(m=>{
  const o=document.createElement("option"); o.value=m; o.textContent=m;
  modeSelect.appendChild(o);
});
function loadSkills(mode){
  skillSelect.innerHTML="";
  Object.keys(DATA.modes[mode]).forEach(s=>{
    const o=document.createElement("option"); o.value=s; o.textContent=s.replace("‚Äì Full Spectrum","").trim();
    skillSelect.appendChild(o);
  });
}
let currentMode = modeNames[0];
loadSkills(currentMode);
let currentSkill = Object.keys(DATA.modes[currentMode])[0];
skillSelect.value = currentSkill;

modeSelect.addEventListener("change", ()=>{
  currentMode = modeSelect.value;
  loadSkills(currentMode);
  currentSkill = skillSelect.value;
  selectSlice(null);
  draw();
});
skillSelect.addEventListener("change", ()=>{
  currentSkill = skillSelect.value;
  selectSlice(null);
  draw();
});

function updateRight(code){
  selMode.textContent = currentMode;
  selSkill.textContent = currentSkill.replace("‚Äì Full Spectrum","").trim();

  if(!code){
    selCode.textContent="‚Äî";
    selBand.textContent="‚Äî";
    actflDesc.textContent="Select a slice to view the descriptor for this mode/skill.";
    courseTableWrap.innerHTML='<div class="muted">No slice selected.</div>';
    return;
  }

  selCode.textContent = `${code} (${CODE_TO_LABEL[code]||code})`;
  selBand.textContent = bandOf(code);

  const skill = DATA.modes[currentMode][currentSkill];
  actflDesc.textContent = (skill.descriptors && skill.descriptors[code]) ? skill.descriptors[code] : "No descriptor listed for this slice in the attached framework.";

  const rows=[];
  for(const [grade,statuses] of Object.entries(skill.grades||{})){
    if(statuses && statuses[code]) rows.push([grade,statuses[code]]);
  }
  if(!rows.length){
    courseTableWrap.innerHTML = `<div class="muted">No SDC course markers at ${code} for this mode/skill.</div>`;
    return;
  }

  courseTableWrap.innerHTML = `
  <table>
    <thead><tr><th style="width:48%;">Course / Grade</th><th>Status at <span style="font-family:var(--mono)">${code}</span></th></tr></thead>
    <tbody>
      ${rows.map(([g,s])=>`<tr><td>${g}</td><td class="status">${s}</td></tr>`).join("")}
    </tbody>
  </table>`;
}

let toastTimer=null;
function showToast(msg){
  toast.textContent=msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove("show"), 1200);
}

/* ========= Canvas 3D-ish Renderer (no external libs) ========= */
const canvas = document.getElementById("stage");
const ctx = canvas.getContext("2d");
const pickCanvas = document.createElement("canvas");
const pctx = pickCanvas.getContext("2d");

function resize(){
  const rect = canvas.parentElement.getBoundingClientRect();
  const dpr = Math.min(window.devicePixelRatio||1, 2);

  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  canvas.style.width = rect.width + "px";
  canvas.style.height = rect.height + "px";
  ctx.setTransform(dpr,0,0,dpr,0,0);

  pickCanvas.width = canvas.width;
  pickCanvas.height = canvas.height;
  pctx.setTransform(dpr,0,0,dpr,0,0);

  draw();
}
window.addEventListener("resize", resize);

// camera
let rotY = 0.55, rotX = -0.38;
let zoom = 1.05;
let dragging=false;
let last={x:0,y:0};
const center = ()=>({x: canvas.parentElement.clientWidth/2, y: canvas.parentElement.clientHeight*0.58});

function rotatePoint(p){
  let x=p.x, y=p.y, z=p.z;
  // X
  const cx=Math.cos(rotX), sx=Math.sin(rotX);
  const y1 = y*cx - z*sx;
  const z1 = y*sx + z*cx;
  y=y1; z=z1;
  // Y
  const cy=Math.cos(rotY), sy=Math.sin(rotY);
  const x2 = x*cy + z*sy;
  const z2 = -x*sy + z*cy;
  return {x:x2,y:y,z:z2};
}
function project(p){
  const c=center();
  const f = 620 * zoom;
  const pp = rotatePoint(p);
  const scale = f / (f + pp.z*120);
  return {x: c.x + pp.x*scale, y: c.y - pp.y*scale, z: pp.z};
}
function poly(points, fill, stroke, lineW, context){
  context.beginPath();
  context.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length;i++) context.lineTo(points[i].x, points[i].y);
  context.closePath();
  if(fill){ context.fillStyle=fill; context.fill(); }
  if(stroke){ context.lineWidth=lineW||1; context.strokeStyle=stroke; context.stroke(); }
}

// pyramid geometry
const SIDES=5;
const TOTAL_H=5.2;
const SLICE_H=TOTAL_H / SLICE_ORDER.length;
const TOP_R=2.8;
const BOT_R=0.22;
function radiusAt(t){ return BOT_R + (TOP_R - BOT_R)*t; }

const slices = SLICE_ORDER.map((code,i)=>{
  const t0=i/SLICE_ORDER.length, t1=(i+1)/SLICE_ORDER.length;
  const r0=radiusAt(t0), r1=radiusAt(t1);
  const y0=-TOTAL_H/2 + i*SLICE_H;
  const y1=y0 + SLICE_H;
  return {code, band: bandOf(code), r0, r1, y0, y1};
});

function ringPoints(r,y){
  const pts=[];
  for(let k=0;k<SIDES;k++){
    const ang = (Math.PI*2*k)/SIDES + Math.PI/5;
    pts.push({x: Math.cos(ang)*r, y, z: Math.sin(ang)*r});
  }
  return pts;
}

// picking
const codeToId = new Map(SLICE_ORDER.map((c,i)=>[c,i+1]));
function pickColor(code){
  const id = codeToId.get(code)||0;
  const r = (id & 255);
  const g = ((id>>8) & 255);
  const b = ((id>>16) & 255);
  return `rgb(${r},${g},${b})`;
}
function codeFromPixel(r,g,b){
  const id = r + (g<<8) + (b<<16);
  if(id<=0) return null;
  return SLICE_ORDER[id-1] || null;
}

let selectedCode=null;
function selectSlice(code){
  selectedCode=code;
  updateRight(code);
}

function drawScene(context, forPick){
  const W=canvas.parentElement.clientWidth;
  const H=canvas.parentElement.clientHeight;
  context.clearRect(0,0,W,H);

  // glow background
  const c=center();
  const grad=context.createRadialGradient(c.x, c.y+90, 10, c.x, c.y+90, 320);
  grad.addColorStop(0, "rgba(27,44,107,0.40)");
  grad.addColorStop(1, "rgba(27,44,107,0.0)");
  context.fillStyle=grad;
  context.fillRect(0,0,W,H);

  // sort back->front
  const sortable = slices.map(s=>{
    const p=rotatePoint({x:s.r1, y:(s.y0+s.y1)/2, z:0});
    return {s, depth:p.z};
  }).sort((a,b)=>a.depth-b.depth);

  sortable.forEach(({s})=>{
    const top=ringPoints(s.r1, s.y1).map(project);
    const bot=ringPoints(s.r0, s.y0).map(project);
    const base=BAND_COLOR[s.band]||[220,220,220];
    const isSel = (s.code===selectedCode);

    for(let k=0;k<SIDES;k++){
      const k2=(k+1)%SIDES;
      const quad=[bot[k], bot[k2], top[k2], top[k]];
      const shade = 0.55 + 0.35*Math.cos((k/SIDES)*Math.PI*2 + rotY);
      const a = forPick ? 1 : (isSel ? 0.98 : 0.90);
      const fill = forPick ? pickColor(s.code) : `rgba(${Math.round(base[0]*shade)},${Math.round(base[1]*shade)},${Math.round(base[2]*shade)},${a})`;
      const stroke = forPick ? null : "rgba(255,255,255,0.10)";
      poly(quad, fill, stroke, 1, context);
    }

    if(!forPick){
      poly(top, null, isSel ? "rgba(255,255,255,0.45)" : "rgba(255,255,255,0.14)", isSel?2:1, context);
      // label
      const front=Math.floor(SIDES*0.25);
      const lp={x:(top[front].x+top[(front+1)%SIDES].x)/2, y:(top[front].y+top[(front+1)%SIDES].y)/2};
      context.font = isSel ? "700 12px var(--sans)" : "600 11px var(--sans)";
      context.fillStyle="rgba(255,255,255,0.88)";
      context.textAlign="center";
      context.fillText(s.code, lp.x, lp.y-6);
    }
  });

  if(!forPick){
    context.strokeStyle="rgba(255,255,255,0.06)";
    context.lineWidth=1;
    context.strokeRect(10,10,W-20,H-20);
  }
}

function draw(){ drawScene(ctx,false); }
function drawPick(){ drawScene(pctx,true); }

canvas.addEventListener("pointerdown",(e)=>{
  dragging=true;
  canvas.setPointerCapture(e.pointerId);
  last={x:e.clientX,y:e.clientY};
});
canvas.addEventListener("pointermove",(e)=>{
  if(!dragging) return;
  const dx=e.clientX-last.x, dy=e.clientY-last.y;
  last={x:e.clientX,y:e.clientY};
  rotY += dx*0.008;
  rotX += dy*0.008;
  rotX = Math.max(-1.1, Math.min(0.3, rotX));
  draw();
});
canvas.addEventListener("pointerup",(e)=>{
  dragging=false;
  canvas.releasePointerCapture(e.pointerId);
});

canvas.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const delta = Math.sign(e.deltaY);
  zoom *= (delta>0) ? 0.94 : 1.06;
  zoom = Math.max(0.72, Math.min(1.6, zoom));
  draw();
},{passive:false});

canvas.addEventListener("click",(e)=>{
  drawPick();
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left), y=(e.clientY-rect.top);
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const px=Math.floor(x*dpr), py=Math.floor(y*dpr);
  const img=pctx.getImageData(px,py,1,1).data;
  const code=codeFromPixel(img[0],img[1],img[2]);
  if(code){
    selectSlice(code);
    showToast(CODE_TO_LABEL[code]||code);
    draw();
  }
});

resetBtn.addEventListener("click",()=>{
  rotY=0.55; rotX=-0.38; zoom=1.05;
  selectSlice(null);
  draw();
});

selectSlice(null);
resize();
</script>
</body>
</html>
