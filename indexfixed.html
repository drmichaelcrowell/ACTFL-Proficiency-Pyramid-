<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACTFL Proficiency Pyramid - SDC Long Sequence Spanish</title>
<style>
  :root {
    --bg0:#0b1020;
    --bg1:#0f1b36;
    --card: rgba(255,255,255,0.06);
    --card2: rgba(255,255,255,0.08);
    --stroke: rgba(255,255,255,0.12);
    --text: rgba(255,255,255,0.92);
    --muted: rgba(255,255,255,0.68);
    --muted2: rgba(255,255,255,0.55);
    --shadow: 0 18px 60px rgba(0,0,0,0.45);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  body {
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--text);
    background: radial-gradient(1100px 700px at 35% 5%, #1a2b60 0%, var(--bg0) 60%),
                radial-gradient(900px 600px at 90% 20%, #132857 0%, transparent 60%),
                linear-gradient(180deg, var(--bg1), var(--bg0));
  }
  .wrap {
    max-width: 1220px;
    margin: 22px auto;
    padding: 0 14px 22px;
  }
  .shell {
    border:1px solid var(--stroke);
    border-radius: 24px;
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .topbar {
    display:flex;
    gap:12px;
    align-items:center;
    padding: 14px 14px 10px;
    border-bottom: 1px solid var(--stroke);
    flex-wrap:wrap;
  }
  select, button {
    appearance:none;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,0.06);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 14px;
    outline:none;
  }
  select:hover, button:hover { background: rgba(255,255,255,0.09); }
  button { cursor:pointer; }
  .hint {
    margin-left:auto;
    color: var(--muted2);
    font-size: 13px;
  }
  .grid {
    display:grid;
    grid-template-columns: 1.05fr 1fr;
    gap: 14px;
    padding: 14px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns: 1fr;}
    .hint{width:100%; margin-left:0;}
  }
  .card {
    border:1px solid var(--stroke);
    border-radius: var(--radius);
    background: rgba(0,0,0,0.18);
    overflow:hidden;
  }
  .cardPad { padding: 14px; }
  .title {
    font-size: 22px;
    font-weight: 850;
    letter-spacing: 0.2px;
    margin: 0 0 4px;
  }
  .subtitle {
    margin:0 0 12px;
    color: var(--muted);
    font-size: 14px;
  }
  .pillRow {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom: 12px;
  }
  .pill {
    border:1px solid var(--stroke);
    background: rgba(255,255,255,0.05);
    padding: 6px 10px;
    border-radius: 999px;
    color: var(--muted);
    font-size: 13px;
    white-space: nowrap;
  }
  .pill b { color: var(--text); }
  .sectionLabel {
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted2);
    margin: 10px 0 8px;
    font-weight: 800;
  }
  .box {
    border:1px solid var(--stroke);
    border-radius: 14px;
    background: rgba(255,255,255,0.04);
    padding: 12px;
  }
  .desc {
    font-size: 15px;
    line-height: 1.45;
  }
  .table {
    width:100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 14px;
  }
  .table th {
    text-align:left;
    color: var(--muted);
    font-weight: 750;
    padding: 10px 8px;
    border-bottom: 1px solid var(--stroke);
  }
  .table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .status {
    display:inline-flex;
    gap:8px;
    align-items:center;
    font-weight: 750;
  }
  .legend {
    display:flex;
    gap:18px;
    flex-wrap:wrap;
    color: var(--muted);
    margin-top: 10px;
  }
  .legend span b { color: var(--text); }
  .stage {
    height: 560px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  @media (max-width: 980px) {
    .stage { height: 520px; }
  }
  svg {
    width: 100%;
    height: 100%;
    max-width: 640px;
    overflow: visible;
  }
  .slice {
    cursor:pointer;
    transition: transform .12s ease, filter .12s ease, opacity .12s ease;
  }
  .slice:hover {
    filter: brightness(1.08);
    transform: translateY(-1px);
  }
  .slice.selected {
    filter: brightness(1.18);
  }
  .sliceShadow {
    opacity: 0.26;
  }
  .labelText {
    font-weight: 850;
    fill: rgba(255,255,255,0.92);
    text-shadow: 0 2px 6px rgba(0,0,0,0.45);
  }
  .codeText {
    font-weight: 800;
    fill: rgba(255,255,255,0.72);
  }
  .frameLine {
    stroke: rgba(255,255,255,0.18);
    stroke-width: 2;
    fill: none;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="shell">
    <div class="topbar">
      <select id="modeSelect" aria-label="Mode"></select>
      <select id="skillSelect" aria-label="Skill"></select>
      <button id="resetBtn" type="button">Reset</button>
      <div class="hint">Click a slice â€¢ Inverted ACTFL pyramid â€¢ Includes Interpretive Reading</div>
    </div>

    <div class="grid">
      <!-- LEFT: Pyramid -->
      <div class="card">
        <div class="stage" id="stage">
          <svg id="pyramidSvg" viewBox="0 0 700 560" role="img" aria-label="ACTFL proficiency pyramid"></svg>
        </div>
      </div>

      <!-- RIGHT: Details -->
      <div class="card">
        <div class="cardPad">
          <div class="title">ACTFL Proficiency Pyramid</div>
          <div class="subtitle">Select mode + skill, then click a slice to view descriptor and SDC expectations.</div>

          <div class="pillRow">
            <div class="pill">Selected: <b id="selKey">â€”</b></div>
            <div class="pill">Band: <b id="selBand">â€”</b></div>
            <div class="pill">Mode: <b id="selMode">â€”</b></div>
            <div class="pill">Skill: <b id="selSkill">â€”</b></div>
          </div>

          <div class="sectionLabel">ACTFL Descriptor</div>
          <div class="box">
            <div class="desc" id="descriptorText">Select a slice to view the descriptor for this mode/skill.</div>
          </div>

          <div class="sectionLabel">SDC Long Sequence Expectation by Course</div>
          <div class="box">
            <div style="color: var(--muted); font-size: 13px;">
              Only courses with Entry/Target/Emerging markers at the selected slice are shown.
            </div>
            <table class="table" id="expectTable">
              <thead>
                <tr><th style="width:70%;">Course / Grade</th><th>Status</th></tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="legend">
              <span>ðŸŒ± <b>Entry</b></span>
              <span>ðŸŒ¿ <b>Target</b></span>
              <span>ðŸŒ³ <b>Emerging</b></span>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
const DATA = {"modes": {"Interpretive Communication": [{"skill": "Interpretive Listening", "descriptors": {"N1": "Recognizes isolated words and memorized phrases with strong contextual support.", "N2": "Understands main ideas and isolated details in short, familiar audio texts.", "N3": "", "N4": "Follows simple spoken messages beyond rehearsed material with partial comprehension.", "I1": "Understands sentence-length spoken language on everyday topics.", "I2": "Understands connected spoken discourse with predictable structure.", "I3": "", "I4": "", "I5": "Understands most conversations on familiar topics, including narration and description.", "A1": "Understands paragraph-length spoken discourse across time frames.", "A2": "Understands detailed spoken texts on personal and public topics.", "A3": "Understands extended discourse with nuance and detail across contexts."}, "expectations": {"N1": [{"course": "1st Grade", "status": "Target"}, {"course": "2nd Grade", "status": "Target"}, {"course": "3rd Grade", "status": "Target"}, {"course": "4th Grade", "status": "Entry"}], "N2": [{"course": "1st Grade", "status": "Emerging"}, {"course": "2nd Grade", "status": "Emerging"}, {"course": "3rd Grade", "status": "Emerging"}, {"course": "4th Grade", "status": "Target"}], "N3": [{"course": "4th Grade", "status": "Emerging"}, {"course": "5th Grade", "status": "Entry"}, {"course": "6th Grade", "status": "Entry"}], "N4": [{"course": "5th Grade", "status": "Target"}, {"course": "6th Grade", "status": "Target"}, {"course": "7th Grade", "status": "Entry"}, {"course": "8th Grade", "status": "Entry"}], "I1": [{"course": "5th Grade", "status": "Emerging"}, {"course": "6th Grade", "status": "Emerging"}, {"course": "7th Grade", "status": "Target"}, {"course": "8th Grade", "status": "Target"}], "I2": [{"course": "7th Grade", "status": "Emerging"}, {"course": "8th Grade", "status": "Emerging"}, {"course": "Honors Spanish I", "status": "Entry"}], "I3": [{"course": "Honors Spanish I", "status": "Target"}, {"course": "9th Grade Honors", "status": "Entry"}], "I4": [{"course": "Honors Spanish I", "status": "Emerging"}, {"course": "9th Grade Honors", "status": "Target"}, {"course": "Honors Spanish II", "status": "Entry"}], "I5": [{"course": "9th Grade Honors", "status": "Emerging"}, {"course": "Honors Spanish II", "status": "Target"}], "A1": [{"course": "Honors Spanish II", "status": "Emerging"}]}}, {"skill": "Interpretive Reading", "descriptors": {"N1": "Identifies familiar words, symbols, and cognates in isolation.", "N2": "Understands short, simple texts on familiar topics using context and visuals.", "N3": "", "N4": "Grasps the gist of short paragraph-length texts when scaffolded.", "I1": "Understands sentence-level texts across everyday contexts.", "I2": "Understands connected texts with organization and supporting detail.", "I3": "", "I4": "", "I5": "Understands narrations and descriptions in familiar genres.", "A1": "Understands paragraph-length texts across time frames.", "A2": "Understands detailed, organized texts on personal and public topics.", "A3": "Understands extended texts with nuance and perspective."}, "expectations": {"N1": [{"course": "1st Grade", "status": "Target"}, {"course": "2nd Grade", "status": "Target"}, {"course": "3rd Grade", "status": "Target"}, {"course": "4th Grade", "status": "Entry"}], "N2": [{"course": "1st Grade", "status": "Emerging"}, {"course": "2nd Grade", "status": "Emerging"}, {"course": "3rd Grade", "status": "Emerging"}, {"course": "4th Grade", "status": "Target"}, {"course": "5th Grade", "status": "Entry"}], "N3": [{"course": "4th Grade", "status": "Emerging"}, {"course": "5th Grade", "status": "Target"}, {"course": "6th Grade", "status": "Entry"}], "N4": [{"course": "5th Grade", "status": "Emerging"}, {"course": "6th Grade", "status": "Target"}, {"course": "7th Grade", "status": "Entry"}, {"course": "8th Grade", "status": "Entry"}], "I1": [{"course": "6th Grade", "status": "Emerging"}, {"course": "7th Grade", "status": "Target"}, {"course": "8th Grade", "status": "Target"}], "I2": [{"course": "7th Grade", "status": "Emerging"}, {"course": "8th Grade", "status": "Emerging"}, {"course": "Honors Spanish I", "status": "Entry"}], "I3": [{"course": "Honors Spanish I", "status": "Target"}, {"course": "9th Grade Honors", "status": "Entry"}], "I4": [{"course": "Honors Spanish I", "status": "Emerging"}, {"course": "9th Grade Honors", "status": "Target"}, {"course": "Honors Spanish II", "status": "Entry"}], "I5": [{"course": "9th Grade Honors", "status": "Emerging"}, {"course": "Honors Spanish II", "status": "Target"}], "A1": [{"course": "Honors Spanish II", "status": "Emerging"}]}}], "Interpersonal Communication": [{"skill": "Interpersonal Oral Interaction", "descriptors": {"N1": "Exchanges meaning using isolated words and memorized phrases, relying heavily on repetition, gestures, and support. Understanding and responses are limited and often fragmented.", "N2": "Participates in simple, predictable exchanges using short sentences. Understands and responds to direct questions related to self and immediate environment, though interaction is often reactive.", "N3": "", "N4": "Manages uncomplicated conversations by asking and answering simple questions. Begins to recombine language and repair breakdowns, but cannot yet sustain interaction consistently.", "I1": "Creates with language to handle everyday interactions and transactions. Can initiate, maintain, and close simple conversations across familiar contexts.", "I2": "Sustains interaction using strings of sentences. Can exchange information, clarify meaning, and maintain conversations on familiar topics with increased independence.", "I3": "", "I4": "", "I5": "Participates in conversations with emerging narration and description, but performance is not yet consistently paragraph-length.", "A1": "Sustains paragraph-length interaction, narrating and describing in past, present, and future time frames. Can handle situations with a complication.", "A2": "Engages confidently in extended conversations with detail, organization, and clarity, interweaving narration and description.", "A3": "Communicates with ease, precision, and fluency across contexts, adapting language to the interaction and interlocutor."}, "expectations": {"N1": [{"course": "1st Grade", "status": "Emerging"}, {"course": "2nd Grade", "status": "Emerging"}, {"course": "3rd Grade", "status": "Emerging"}, {"course": "4th Grade", "status": "Target"}, {"course": "5th Grade", "status": "Entry"}], "N2": [{"course": "4th Grade", "status": "Emerging"}, {"course": "5th Grade", "status": "Target"}, {"course": "6th Grade", "status": "Entry"}], "N3": [{"course": "5th Grade", "status": "Emerging"}, {"course": "6th Grade", "status": "Target"}, {"course": "7th Grade", "status": "Entry"}, {"course": "8th Grade", "status": "Entry"}], "N4": [{"course": "6th Grade", "status": "Emerging"}, {"course": "7th Grade", "status": "Target"}, {"course": "8th Grade", "status": "Target"}, {"course": "Honors Spanish I", "status": "Entry"}], "I1": [{"course": "7th Grade", "status": "Emerging"}, {"course": "8th Grade", "status": "Emerging"}, {"course": "Honors Spanish I", "status": "Target"}, {"course": "9th Grade Honors", "status": "Entry"}], "I2": [{"course": "Honors Spanish I", "status": "Emerging"}, {"course": "9th Grade Honors", "status": "Target"}, {"course": "Honors Spanish II", "status": "Entry"}], "I3": [{"course": "9th Grade Honors", "status": "Emerging"}, {"course": "Honors Spanish II", "status": "Target"}], "I4": [{"course": "Honors Spanish II", "status": "Emerging"}]}}, {"skill": "Interpersonal Written Interaction", "descriptors": {"N1": "Exchanges meaning by copying or reproducing familiar words and phrases. Relies heavily on models and may switch to another language to maintain interaction.", "N2": "Participates in simple written exchanges using short, practiced sentences. Can read and respond to highly predictable messages on familiar topics.", "N3": "", "N4": "Manages basic written interactions by asking and answering simple questions and recombining familiar language, though exchanges remain short and uneven.", "I1": "Creates with language in written exchanges to meet everyday needs. Can maintain back-and-forth communication using connected sentences.", "I2": "Sustains written interaction using strings of sentences, clarifying meaning and exchanging information across familiar contexts.", "I3": "", "I4": "", "I5": "Participates in written exchanges with emerging paragraph-level organization, though breakdowns may occur when complexity increases.", "A1": "Sustains paragraph-length written interaction, narrating and describing across time frames in exchanges.", "A2": "Engages in extended written interaction with detail, cohesion, and clarity, adjusting language to context and audience.", "A3": "Writes interactively with precision, nuance, and stylistic control, maintaining coherent and purposeful exchanges across contexts."}, "expectations": {"N1": [{"course": "1st Grade", "status": "Emerging"}, {"course": "2nd Grade", "status": "Emerging"}, {"course": "3rd Grade", "status": "Emerging"}, {"course": "4th Grade", "status": "Target"}, {"course": "5th Grade", "status": "Entry"}], "N2": [{"course": "4th Grade", "status": "Emerging"}, {"course": "5th Grade", "status": "Target"}, {"course": "6th Grade", "status": "Entry"}], "N3": [{"course": "5th Grade", "status": "Emerging"}, {"course": "6th Grade", "status": "Target"}], "N4": [{"course": "6th Grade", "status": "Emerging"}, {"course": "7th Grade", "status": "Entry"}, {"course": "8th Grade", "status": "Entry"}], "I1": [{"course": "7th Grade", "status": "Target"}, {"course": "8th Grade", "status": "Target"}, {"course": "Honors Spanish I", "status": "Entry"}], "I2": [{"course": "7th Grade", "status": "Emerging"}, {"course": "8th Grade", "status": "Emerging"}, {"course": "Honors Spanish I", "status": "Target"}, {"course": "9th Grade Honors", "status": "Entry"}], "I3": [{"course": "Honors Spanish I", "status": "Emerging"}, {"course": "9th Grade Honors", "status": "Target"}, {"course": "Honors Spanish II", "status": "Entry"}], "I4": [{"course": "9th Grade Honors", "status": "Emerging"}, {"course": "Honors Spanish II", "status": "Target"}], "I5": [{"course": "Honors Spanish II", "status": "Emerging"}]}}], "Presentational Communication": [{"skill": "Presentational Speaking", "descriptors": {"N1": "Produces lists and memorized phrases.", "N2": "Presents basic information using short sentences on familiar topics.", "N3": "", "N4": "Produces connected sentences to express personal meaning.", "I1": "Creates with language to present on everyday topics.", "I2": "Sustains organized presentations using sentence strings.", "I3": "", "I4": "", "I5": "Presents with emerging paragraph-level organization.", "A1": "Produces paragraph-length presentations across time frames.", "A2": "Produces detailed, organized presentations on personal and public topics.", "A3": "Presents with clarity, precision, and rhetorical control."}, "expectations": {"N1": [{"course": "1st Grade", "status": "Target"}, {"course": "2nd Grade", "status": "Target"}, {"course": "3rd Grade", "status": "Target"}, {"course": "4th Grade", "status": "Entry"}], "N2": [{"course": "1st Grade", "status": "Emerging"}, {"course": "2nd Grade", "status": "Emerging"}, {"course": "3rd Grade", "status": "Emerging"}, {"course": "4th Grade", "status": "Target"}, {"course": "5th Grade", "status": "Entry"}], "N3": [{"course": "4th Grade", "status": "Emerging"}, {"course": "5th Grade", "status": "Target"}, {"course": "6th Grade", "status": "Entry"}], "N4": [{"course": "5th Grade", "status": "Emerging"}, {"course": "6th Grade", "status": "Target"}, {"course": "7th Grade", "status": "Entry"}, {"course": "8th Grade", "status": "Entry"}], "I1": [{"course": "6th Grade", "status": "Emerging"}, {"course": "7th Grade", "status": "Target"}, {"course": "8th Grade", "status": "Target"}], "I2": [{"course": "7th Grade", "status": "Emerging"}, {"course": "8th Grade", "status": "Emerging"}, {"course": "Honors Spanish I", "status": "Entry"}], "I3": [{"course": "Honors Spanish I", "status": "Target"}, {"course": "9th Grade Honors", "status": "Entry"}], "I4": [{"course": "Honors Spanish I", "status": "Emerging"}, {"course": "9th Grade Honors", "status": "Target"}, {"course": "Honors Spanish II", "status": "Entry"}], "I5": [{"course": "9th Grade Honors", "status": "Emerging"}, {"course": "Honors Spanish II", "status": "Target"}], "A1": [{"course": "Honors Spanish II", "status": "Emerging"}]}}, {"skill": "Presentational Writing", "descriptors": {"N1": "Copies or reproduces words and phrases.", "N2": "Writes simple sentences and short messages on familiar topics.", "N3": "", "N4": "Begins short paragraph-like writing through recombination.", "I1": "Writes connected sentences to communicate meaning.", "I2": "Writes organized texts using sentence strings.", "I3": "", "I4": "", "I5": "Writes with emerging paragraph structure and narration.", "A1": "Writes paragraph-length texts across time frames.", "A2": "Writes detailed, organized texts with cohesion and clarity.", "A3": "Writes with precision, nuance, and stylistic control."}, "expectations": {"N1": [{"course": "1st Grade", "status": "Target"}, {"course": "2nd Grade", "status": "Target"}, {"course": "3rd Grade", "status": "Target"}, {"course": "4th Grade", "status": "Entry"}], "N2": [{"course": "1st Grade", "status": "Emerging"}, {"course": "2nd Grade", "status": "Emerging"}, {"course": "3rd Grade", "status": "Emerging"}, {"course": "4th Grade", "status": "Target"}, {"course": "5th Grade", "status": "Entry"}], "N3": [{"course": "4th Grade", "status": "Emerging"}, {"course": "5th Grade", "status": "Target"}, {"course": "6th Grade", "status": "Entry"}], "N4": [{"course": "5th Grade", "status": "Emerging"}, {"course": "6th Grade", "status": "Target"}, {"course": "7th Grade", "status": "Entry"}, {"course": "8th Grade", "status": "Entry"}], "I1": [{"course": "6th Grade", "status": "Emerging"}, {"course": "7th Grade", "status": "Target"}, {"course": "8th Grade", "status": "Target"}], "I2": [{"course": "7th Grade", "status": "Emerging"}, {"course": "8th Grade", "status": "Emerging"}, {"course": "Honors Spanish I", "status": "Entry"}], "I3": [{"course": "Honors Spanish I", "status": "Target"}, {"course": "9th Grade Honors", "status": "Entry"}], "I4": [{"course": "Honors Spanish I", "status": "Emerging"}, {"course": "9th Grade Honors", "status": "Target"}, {"course": "Honors Spanish II", "status": "Entry"}], "I5": [{"course": "9th Grade Honors", "status": "Emerging"}, {"course": "Honors Spanish II", "status": "Target"}], "A1": [{"course": "Honors Spanish II", "status": "Emerging"}]}}]}};
const LEVELS = [{"key": "N1", "label": "Novice Low", "code": "N1", "band": "Novice"}, {"key": "N2", "label": "Novice Mid", "code": "N2", "band": "Novice"}, {"key": "N3", "label": "Novice Mid", "code": "N3", "band": "Novice"}, {"key": "N4", "label": "Novice High", "code": "N4", "band": "Novice"}, {"key": "I1", "label": "Intermediate Low", "code": "I1", "band": "Intermediate"}, {"key": "I2", "label": "Intermediate Mid", "code": "I2", "band": "Intermediate"}, {"key": "I3", "label": "Intermediate Mid", "code": "I3", "band": "Intermediate"}, {"key": "I4", "label": "Intermediate High", "code": "I4", "band": "Intermediate"}, {"key": "I5", "label": "Intermediate High", "code": "I5", "band": "Intermediate"}, {"key": "A1", "label": "Advanced Low", "code": "A1", "band": "Advanced"}, {"key": "A2", "label": "Advanced Mid", "code": "A2", "band": "Advanced"}, {"key": "A3", "label": "Advanced High", "code": "A3", "band": "Advanced"}, {"key": "S", "label": "Superior", "code": "S", "band": "Superior"}, {"key": "D", "label": "Distinguished", "code": "D", "band": "Distinguished"}];
const BAND_COLORS = {"Novice": "#2f6fed", "Intermediate": "#2ea44f", "Advanced": "#f08c2e", "Superior": "#f2c94c", "Distinguished": "#e5e7eb"};

const ui = {
  modeSelect: document.getElementById('modeSelect'),
  skillSelect: document.getElementById('skillSelect'),
  resetBtn: document.getElementById('resetBtn'),
  svg: document.getElementById('pyramidSvg'),
  selKey: document.getElementById('selKey'),
  selBand: document.getElementById('selBand'),
  selMode: document.getElementById('selMode'),
  selSkill: document.getElementById('selSkill'),
  descriptorText: document.getElementById('descriptorText'),
  expectTbody: document.querySelector('#expectTable tbody'),
};

let state = {
  mode: null,
  skill: null,
  levelKey: null
};

function escapeHtml(s) {
  return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function statusEmoji(status) {
  if (status === 'Entry') return 'ðŸŒ±';
  if (status === 'Target') return 'ðŸŒ¿';
  if (status === 'Emerging') return 'ðŸŒ³';
  return 'â€¢';
}

function buildModeOptions() {
  ui.modeSelect.innerHTML = '';
  Object.keys(DATA.modes).forEach(mode => {
    const opt = document.createElement('option');
    opt.value = mode;
    opt.textContent = mode;
    ui.modeSelect.appendChild(opt);
  });
}

function buildSkillOptions(mode) {
  ui.skillSelect.innerHTML = '';
  const skills = (DATA.modes[mode] || []).map(s => s.skill);
  skills.forEach(skill => {
    const opt = document.createElement('option');
    opt.value = skill;
    opt.textContent = skill;
    ui.skillSelect.appendChild(opt);
  });
}

function getSkillObj(mode, skillName) {
  return (DATA.modes[mode] || []).find(s => s.skill === skillName);
}

function setState(partial) {
  state = {...state, ...partial};
  render();
}

function resetAll() {
  const firstMode = Object.keys(DATA.modes)[0];
  buildSkillOptions(firstMode);
  const firstSkill = (DATA.modes[firstMode]?.[0]?.skill) || null;
  setState({ mode: firstMode, skill: firstSkill, levelKey: 'N1' });
  ui.modeSelect.value = firstMode;
  ui.skillSelect.value = firstSkill;
}

function render() {
  // Update header pills
  const level = LEVELS.find(l => l.key === state.levelKey) || null;
  ui.selKey.textContent = level ? `${level.code}  (${level.label})` : 'â€”';
  ui.selBand.textContent = level ? level.band : 'â€”';
  ui.selMode.textContent = state.mode || 'â€”';
  ui.selSkill.textContent = state.skill || 'â€”';

  // Update descriptor + expectations
  const skillObj = getSkillObj(state.mode, state.skill);
  let desc = '';
  if (skillObj && state.levelKey) {
    desc = skillObj.descriptors?.[state.levelKey] || '';
  }
  if (!desc) {
    if (state.levelKey === 'S' || state.levelKey === 'D') {
      desc = 'Not included in the SDC long-sequence proficiency chart (this display extends ACTFL bands for context).';
    } else {
      desc = 'No descriptor is provided for this slice in the current chart.';
    }
  }
  ui.descriptorText.textContent = desc;

  ui.expectTbody.innerHTML = '';
  const rows = (skillObj?.expectations?.[state.levelKey] || []);
  if (rows.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" style="color: rgba(255,255,255,0.55); padding: 14px 8px;">No course markers at this slice.</td>`;
    ui.expectTbody.appendChild(tr);
  } else {
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.course)}</td>
        <td><span class="status">${statusEmoji(r.status)} ${escapeHtml(r.status)}</span></td>
      `;
      ui.expectTbody.appendChild(tr);
    });
  }

  // Update selected style
  [...ui.svg.querySelectorAll('.slice')].forEach(el => {
    el.classList.toggle('selected', el.dataset.key === state.levelKey);
  });
}

function drawPyramid() {
  // Clear
  ui.svg.innerHTML = '';

  const W = 700, H = 560;
  const topY = 70;
  const bottomY = 500;
  const slices = LEVELS.length;

  // Inverted funnel: narrow at bottom, wide at top
  const minW = 140;      // bottom width (Novice Low)
  const maxW = 560;      // top width (Distinguished)
  const sliceH = (bottomY - topY) / slices;

  // Frame outline (like ACTFL funnel)
  const frame = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  const xTopL = (W - maxW)/2, xTopR = xTopL + maxW;
  const xBotL = (W - minW)/2, xBotR = xBotL + minW;
  frame.setAttribute('d', `M ${xTopL} ${topY} L ${xTopR} ${topY} L ${xBotR} ${bottomY} L ${xBotL} ${bottomY} Z`);
  frame.setAttribute('class','frameLine');
  ui.svg.appendChild(frame);

  // Slight base shadow ellipse
  const ell = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
  ell.setAttribute('cx', W/2);
  ell.setAttribute('cy', bottomY + 26);
  ell.setAttribute('rx', 250);
  ell.setAttribute('ry', 22);
  ell.setAttribute('fill', 'rgba(0,0,0,0.28)');
  ui.svg.appendChild(ell);

  // Gradients per band
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const bands = Array.from(new Set(LEVELS.map(l => l.band)));
  bands.forEach(b => {
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
    g.setAttribute('id', `grad-${b}`);
    g.setAttribute('x1','0'); g.setAttribute('y1','0'); g.setAttribute('x2','1'); g.setAttribute('y2','1');
    const c = BAND_COLORS[b] || '#999';
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop1.setAttribute('offset','0%');
    stop1.setAttribute('stop-color', c);
    stop1.setAttribute('stop-opacity','0.95');
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop2.setAttribute('offset','100%');
    stop2.setAttribute('stop-color', c);
    stop2.setAttribute('stop-opacity','0.70');
    g.appendChild(stop1); g.appendChild(stop2);
    defs.appendChild(g);
  });
  ui.svg.appendChild(defs);

  // Helper to compute width at a given slice boundary (0 bottom, 1 top)
  function widthAt(t) {
    // t: 0 bottom -> 1 top
    return minW + (maxW - minW) * t;
  }

  // Build slices bottom -> top
  for (let i=0; i<slices; i++) {
    const level = LEVELS[i];
    // y0 bottom of this slice, y1 top of this slice
    const y0 = bottomY - i*sliceH;
    const y1 = bottomY - (i+1)*sliceH;

    const t0 = (y0 - topY) / (bottomY - topY); // 0..1
    const t1 = (y1 - topY) / (bottomY - topY);

    // Inverted funnel: wider at top => width uses t
    const w0 = widthAt(1 - t0);
    const w1 = widthAt(1 - t1);

    const x0L = (W - w0)/2, x0R = x0L + w0;
    const x1L = (W - w1)/2, x1R = x1L + w1;

    // shadow polygon for depth
    const sh = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    sh.setAttribute('points', `${x1L+10},${y1+8} ${x1R+10},${y1+8} ${x0R+10},${y0+8} ${x0L+10},${y0+8}`);
    sh.setAttribute('fill', 'rgba(0,0,0,0.55)');
    sh.setAttribute('class','sliceShadow');
    ui.svg.appendChild(sh);

    const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    poly.setAttribute('points', `${x1L},${y1} ${x1R},${y1} ${x0R},${y0} ${x0L},${y0}`);
    poly.setAttribute('fill', `url(#grad-${level.band})`);
    poly.setAttribute('stroke', 'rgba(255,255,255,0.14)');
    poly.setAttribute('stroke-width', '1.2');
    poly.setAttribute('class', 'slice');
    poly.dataset.key = level.key;
    poly.addEventListener('click', () => setState({ levelKey: level.key }));
    ui.svg.appendChild(poly);

    // labels
    const cx = W/2;
    const cy = (y0 + y1)/2;

    const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    name.setAttribute('x', cx);
    name.setAttribute('y', cy - 3);
    name.setAttribute('text-anchor','middle');
    name.setAttribute('class','labelText');
    name.setAttribute('font-size', level.band === 'Distinguished' ? '20' : (level.band === 'Superior' ? '18' : '14'));
    name.textContent = level.label;
    ui.svg.appendChild(name);

    const code = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    code.setAttribute('x', cx);
    code.setAttribute('y', cy + 14);
    code.setAttribute('text-anchor','middle');
    code.setAttribute('class','codeText');
    code.setAttribute('font-size', '12');
    code.textContent = level.code;
    ui.svg.appendChild(code);
  }
}

function wireEvents() {
  ui.modeSelect.addEventListener('change', (e) => {
    const mode = e.target.value;
    buildSkillOptions(mode);
    const firstSkill = ui.skillSelect.options[0]?.value || null;
    setState({ mode, skill: firstSkill, levelKey: 'N1' });
  });

  ui.skillSelect.addEventListener('change', (e) => {
    setState({ skill: e.target.value, levelKey: state.levelKey || 'N1' });
  });

  ui.resetBtn.addEventListener('click', resetAll);
}

function init() {
  buildModeOptions();
  wireEvents();
  drawPyramid();
  resetAll();
}

init();
</script>
</body>
</html>
